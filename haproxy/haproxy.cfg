global
    daemon

defaults
    mode http
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend http_frontend
    bind *:80

    # Letâ€™s Encrypt HTTP challenge
    acl letsencrypt path_beg /.well-known/acme-challenge/
    use_backend certbot_backend if letsencrypt

    # Redirect everything else to HTTPS
    redirect scheme https code 301

frontend https_frontend
    bind *:443 ssl crt /usr/local/etc/haproxy/certs/haproxy.pem

    # WebSocket detection
    acl is_websocket hdr(Upgrade) -i websocket

    # Route WebSocket traffic
    use_backend websocket_backend if is_websocket

    # Route everything else to API
    default_backend api_backend

backend api_backend
    server server1 server:8888 check

backend websocket_backend
    server websocket1 server:8765 check

backend certbot_backend
    server certbot certbot:80 check
